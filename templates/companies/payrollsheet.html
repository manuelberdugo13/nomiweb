{% extends 'base/base_companies.html' %}
{% load crispy_forms_tags %}

{% block title %}
    Nomiweb.co - Portal Empresas - Cargos 
{% endblock %}

{% block css %}
{% endblock %}

{% block sub_titulo1 %} 
    Nomina
{% endblock %}

{% block sub_titulo2 %} 
    Planilla de Nómina 
{% endblock %}

{% block titulo2 %} 
    Activos 
{% endblock %}

{% block content %}

<main class="flex-grow-1">
    <div class="card shadow-sm">
        <div class="card-header">
            <h3 class="card-title">Plantilla de Nómina</h3>
        </div>
        <div class="card-body">
            <form method="get">
                <div class="input-group input-group-sm mb-5">
                    <select name="nomina" id="nomina" onchange="cargarNominas()" class="form-select" data-control="select2" data-placeholder="Seleccione una opción" aria-label="Seleccione un empleado:">
                        <option value="">Seleccione...</option>
                        {% for nomina in nominas %}
                            <option value="{{ nomina.1 }}" {% if nomina.1|stringformat:"s" == selected_nomina %}selected{% endif %}>
                                {{ nomina.0 }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
            </form>
        </div>
    </div>
    <br>
    <br>
    <div class="table-responsive">
        <table id='tabla-planilla-nomina' class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Documento</th>
                    <th>Nombre</th>
                    <th>Básico</th>
                    <th>Tpte</th>
                    <th>Extras</th>
                    <th>Otros Ing.</th>
                    <th>Ingresos</th>
                    <th>Aportes</th>
                    <th>Prestamos</th>
                    <th>Otros Desc.</th>
                    <th>Descuentos</th>
                    <th>Neto</th>
                    <th>Comp.</th>
                    <th>E-mail</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
                {% for compect in compects %}
                    <tr>
                        <td>{{ compect.documento }}</td>
                        <td>{{ compect.nombre }}</td>
                        <td>{{ compect.basico }}</td>
                        <td>{{ compect.tpte }}</td>
                        <td>{{ compect.extras }}</td>
                        <td>{{ compect.otrosing }}</td>
                        <td>{{ compect.ingresos }}</td>
                        <td>{{ compect.aportess }}</td>
                        <td>{{ compect.prestamos }}</td>
                        <td>{{ compect.otrosdesc }}</td>
                        <td>{{ compect.descuentos }}</td>
                        <td>{{ compect.neto }}</td>
                        <td>
                            <a href="#" class="btn btn-icon btn-light-success hover-scale btn-sm">
                                <i class="fa-solid fa-file fs-1"></i>
                            </a> 
                        </td>
                        <td>
                            <a href="#" class="btn btn-icon btn-light-success hover-scale btn-sm">
                                <i class="fa-regular fa-paper-plane fs-1"></i>
                            </a> 
                        </td>
                        <td>
                            {% if compect.estado == 'Enviado' %}
                                
                                <div class="btn-group" role="group" aria-label="Basic example">
                                    <button type="button" class="btn btn-icon btn-light-success hover-scale btn-sm" data-bs-toggle="tooltip" data-bs-custom-class="tooltip-inverse" data-bs-placement="right" title="Enviado" >
                                        <i class="fa-solid fa-envelope-circle-check fs-1"></i>
                                    </button>
                                    <button type="button" class="btn btn-secondary">Enviado</button>
                                </div>
                            {% elif compect.estado == 'Error' %}
                                <div class="btn-group" role="group" aria-label="Basic example">
                                    <button type="button" class="btn btn-icon btn-light-success hover-scale btn-sm" data-bs-toggle="tooltip" data-bs-custom-class="tooltip-inverse" data-bs-placement="right" title="Error" >
                                        <i class="fa-solid fa-circle-exclamation fs-1"></i>
                                    </button> 
                                    <button type="button" class="btn btn-secondary">Error</button>
                                </div>
                            {% else %}
                                <div class="btn-group" role="group" aria-label="Basic example">
                                    <button type="button" class="btn btn-icon btn-light-success hover-scale btn-sm" data-bs-toggle="tooltip" data-bs-custom-class="tooltip-inverse" data-bs-placement="right" title="No Enviado" >
                                        <i class="fa-solid fa-envelope fs-1"></i>
                                    </button> 
                                    <button type="button" class="btn btn-secondary">No Enviado</button>
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <th>Total Acumulado</th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </tfoot>
        </table>
    </div>
</main>

<div class="modal fade" id="emailModal" tabindex="-1" role="dialog" aria-labelledby="emailModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="emailModalLabel">Enviar Correos</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas enviar correos masivos de la nómina seleccionada?</p>
                <form method="get">
                    <div class="input-group input-group-sm mb-5">
                        <select name="nomina2" id="nomina2" class="form-select" data-control="select2" data-placeholder="Seleccione una opción" aria-label="Seleccione un empleado:" disabled>
                            {% for nomina in nominas %}
                                <option value="{{ nomina.1 }}" {% if nomina.1|stringformat:"s" == selected_nomina %}selected{% endif %}>
                                    {{ nomina.0 }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </form>                
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary">Enviar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block js %}

<script>
    function cargarNominas() {
        var nominaSelect = document.getElementById('nomina');
        var nominaId = nominaSelect.value;
        window.location.href = `?nomina=${nominaId}`;
    }
</script>

<script>
    $(document).ready(function() {
        // Inicializar DataTable
        var table = $('#tabla-planilla-nomina').DataTable({
            language: {
                "decimal":        "",
                "emptyTable":     "No hay datos disponibles en la tabla",
                "info":           "Mostrando _START_ a _END_ de _TOTAL_ entradas",
                "infoEmpty":      "Mostrando 0 a 0 de 0 entradas",
                "infoFiltered":   "(filtrado de _MAX_ entradas totales)",
                "infoPostFix":    "",
                "thousands":      ".",
                "lengthMenu":     "Mostrar _MENU_ entradas",
                "loadingRecords": "Cargando...",
                "processing":     "Procesando...",
                "search":         "Buscar:",
                "zeroRecords":    "No se encontraron registros coincidentes",
                "paginate": {
                    "first":      "Primero",
                    "last":       "Último",
                    "next":       "Siguiente",
                    "previous":   "Anterior"
                },
                "aria": {
                    "sortAscending":  ": activar para ordenar la columna ascendente",
                    "sortDescending": ": activar para ordenar la columna descendente"
                }
            },
            dom: 'Bfrtip',
            buttons: [
                {
                    text: ' <i class="fas fa-envelope"></i> Enviar Correos ',
                    className: 'btn btn-light-info',
                    action: function ( e, dt, node, config ) {
                        $('#emailModal').modal('show'); // Abre el modal
                    }
                },
                {
                    text: ' Resumen de Nomina ',
                    action: function (e, dt, node, config) {
                        showLoadingAnimation();
                        setTimeout(function(){
                            window.location.href = "{% url 'companies:exportar_excel1' %}";
                        }, 100);
                    },
                    className: 'btn btn-light-info'
                },
            ],
            order: [[1, 'asc']],  
            "footerCallback": function (row, data, start, end, display) {
                var api = this.api(), data;

                // Total de cada columna numérica
                var columnasNumericas = [3, 4, 5, 6, 7, 8, 9, 10, 11];
                
                for (var i = 0; i < columnasNumericas.length; i++) {
                    var total = api
                        .column(columnasNumericas[i], { search: 'applied' })
                        .data()
                        .reduce(function (a, b) {
                            return parseFloat(a.toString().replace(/\./g,'').replace(/\,/g,'.')) + parseFloat(b.toString().replace(/\./g,'').replace(/\,/g,'.'));
                        }, 0);
                    $(api.column(columnasNumericas[i]).footer()).html(total.toFixed(0).replace(/\./g, '.').replace(/\B(?=(\d{3})+(?!\d))/g, "."));
                }
            },
            "pageLength": 10
        });
    });
</script>
{% endblock %}
