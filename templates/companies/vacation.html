{% extends 'base/base_companies.html' %}
{% load crispy_forms_tags %}


{% block title %}
    Nomiweb.co - Portal Empresas - Incapacidades
{% endblock %}


{% block css %}

    .loan-status-checkbox {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
    }
{% endblock %}

{% block sub_titulo1 %} 
Novedades de Nomina
{% endblock %}


{% block sub_titulo2 %} 
Vacaciones
{% endblock %}

{% block actions %}

<button type="button" class="btn btn-light-info" data-bs-toggle="modal" data-bs-target="#kt_modal_1">
    <i class="fa-solid fa-plus"></i> Vacaciones
</button>  

{% endblock %}

{% block titulo2 %} 
Listado de Vacaciones
{% endblock %}


{% block content %}
    
<table class="table align-middle table-row-dashed fs-6 gy-4" id="kt_docs_datatable_subtable">
	<!--begin::Table head-->
	<thead>
		<!--begin::Table row-->
		<tr class="text-start text-gray-500 fw-bold fs-7 text-uppercase gs-0">
			<th class="min-w-100px">Order ID</th>
			<th class="text-end min-w-100px">Created</th>
			<th class="text-end min-w-150px">Customer</th>
			<th class="text-end min-w-100px">Total</th>
			<th class="text-end min-w-100px">Profit</th>
			<th class="text-end min-w-50px">Status</th>
			<th class="text-end"></th>
		</tr>
		<!--end::Table row-->
	</thead>
	<!--end::Table head-->


	<!--begin::Table body-->
	<tbody class="fw-bold text-gray-600">
		<!--begin::SubTable template-->
		<tr data-kt-docs-datatable-subtable="subtable_template" class="d-none">
			<td colspan="2">
				<div class="d-flex align-items-center gap-3">
					<a href="#" class="symbol symbol-50px bg-secondary bg-opacity-25 rounded">
						<img src="/assets/media/stock/ecommerce/" alt="" data-kt-docs-datatable-subtable="template_image" />
					</a>
					<div class="d-flex flex-column text-muted">
						<a href="#" class="text-gray-900 text-hover-primary fw-bold" data-kt-docs-datatable-subtable="template_name">Product name</a>
						<div class="fs-7" data-kt-docs-datatable-subtable="template_description">Product description</div>
					</div>
				</div>
			</td>
			<td class="text-end">
				<div class="text-gray-900 fs-7">Cost</div>
				<div class="text-muted fs-7 fw-bold" data-kt-docs-datatable-subtable="template_cost">1</div>
			</td>
			<td class="text-end">
				<div class="text-gray-900 fs-7">Qty</div>
				<div class="text-muted fs-7 fw-bold" data-kt-docs-datatable-subtable="template_qty">1</div>
			</td>
			<td class="text-end">
				<div class="text-gray-900 fs-7">Total</div>
				<div class="text-muted fs-7 fw-bold" data-kt-docs-datatable-subtable="template_total">name</div>
			</td>
			<td class="text-end">
				<div class="text-gray-900 fs-7 me-3">On hand</div>
				<div class="text-muted fs-7 fw-bold" data-kt-docs-datatable-subtable="template_stock">32</div>
			</td>
			<td></td>
		</tr>
		<!--end::SubTable template-->

		<tr>
			<!--begin::Order ID-->
			<td>
				<a href="#" class="text-gray-900 text-hover-primary">#XGT-346</a>
			</td>
			<!--end::Order ID-->

			<!--begin::Crated date-->
			<td class="text-end">
				10 Nov 2021, 10:30 am
			</td>
			<!--end::Created date-->

			<!--begin::Customer-->
			<td class="text-end">
				<a href="" class="text-gray-900 text-hover-primary">Emma Smith</a>
			</td>
			<!--end::Customer-->

			<!--begin::Total-->
			<td class="text-end">
				$630.00
			</td>
			<!--end::Total-->

			<!--begin::Profit-->
			<td class="text-end">
				<span class="text-gray-900 fw-bold">$86.70</span>
			</td>
			<!--end::Profit-->

			<!--begin::Status-->
			<td class="text-end">
				<span class="badge py-3 px-4 fs-7 badge-light-primary">Confirmed</span>
			</td>
			<!--end::Status-->

			<!--begin::Actions-->
			<td class="text-end">
				<button type="button" class="btn btn-sm btn-icon btn-light btn-active-light-primary toggle h-25px w-25px"
					data-kt-docs-datatable-subtable="expand_row">
					<span class="svg-icon fs-3 m-0 toggle-off">...</span>
					<span class="svg-icon fs-3 m-0 toggle-on">...</span>
				</button>
			</td>
			<!--end::Actions-->
		</tr>

			...
	</tbody>
	<!--end::Table body-->
</table>



    {% if vacaciones %}
    <div class="table-responsive">
        <table class="table table-bordered" id="table-vacation" >
            <thead>
                <tr class="fw-bold fs-6 text-gray-800"> 
                    <th>Id Contrato</th>
                    <th>Documento</th>
                    <th>Apellidos y Nombre</th>
                    <th>Entidad</th>
                    <th>Codigo Diagnostico</th>
                    <th>Diagnostico</th>
                    <th>Prorroga</th>
                    <th>Fecha Inicial</th>
                    <th>dias Incapacidad</th>
                    <th ><i class="fa-regular fa-image fs-3"></i></th>
                    <th> </th>
                </tr>
            </thead>
            <tbody>
                {% for item in vacaciones %}
                    <tr>
                        <td>{{ item.idcontrato__idcontrato }}</td>
                        <td>{{ item.idempleado__docidentidad }}</td>
                        <td> {{ item.idempleado__papellido }} {{ item.idempleado__sapellido }} {{ item.idempleado__pnombre }} {{ item.idempleado__snombre }} </td>
                        <td>{{ item.entidad }}</td>
                        <td>{{ item.coddiagnostico__coddiagnostico }}</td>
                        <td>{{ item.diagnostico }}</td>
                        <td>{{ item.prorroga }}</td>
                        <td>{{ item.fechainicial | date:"d/m/Y"  }}</td>
                        <td>{{ item.dias }}</td>
                        <td>
                            <a href="#" class="btn btn-icon btn-light-info">
                                <i class="fa-solid fa-file-image fs-3"></i>
                            </a>
                        </td>
                        <td>
                            <button type="button" class="btn btn-icon btn-light-info" data-bs-toggle="modal" data-bs-target="#kt_modal_2" data-whatever="@mdo" >
                                <i class="fa-solid fa-pen-to-square fs-3"></i>
                            </button>   
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

{% else %}
    <div class="alert alert-primary" role="alert">
        <h4 class="alert-heading">¡Atención!</h4>
        <p>Parece que no hay vacaciones registradas en este momento. Por favor, agregue una vacaciones para visualizar los datos correspondientes.</p>
        <hr>
        <p class="mb-0">Agradecemos su colaboración para completar esta información.</p>
    </div>
{% endif %}


<div class="modal fade" tabindex="-1" id="kt_modal_1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"> Nueva Vacacion </h3>
    
                <!--begin::Close-->
                <div class="btn btn-icon btn-sm btn-active-light-primary ms-2" data-bs-dismiss="modal" aria-label="Close">
                    <i class="ki-duotone ki-cross fs-1"><span class="path1"></span><span class="path2"></span></i>
                </div>
                <!--end::Close-->
            </div>
    
            <div class="modal-body">
                {% crispy form %}
            </div>
    
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary" form="form_loans" >Crear Vacacion </button>
            </div>
        </div>
    </div>
</div>
    

<div class="modal fade" tabindex="-1" id="kt_modal_2">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"> Editar Vacacion</h3>
    
                <!--begin::Close-->
                <div class="btn btn-icon btn-sm btn-active-light-primary ms-2" data-bs-dismiss="modal" aria-label="Close">
                    <i class="ki-duotone ki-cross fs-1"><span class="path1"></span><span class="path2"></span></i>
                </div>
                <!--end::Close-->
            </div>
    
            <div class="modal-body">
                {% crispy form %}
            </div>
    
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary" form="form_loans" >Actualizar Vacacion</button>
            </div>
        </div>
    </div>
</div>





{% endblock %}






{% block js %}

<script>

    "use strict";

// Class definition
var KTDocsDatatableSubtable = function () {
    var table;
    var datatable;
    var template;

    // Private methods
    const initDatatable = () => {
        // Set date data order
        const tableRows = table.querySelectorAll('tbody tr');

        tableRows.forEach(row => {
            const dateRow = row.querySelectorAll('td');
            const realDate = moment(dateRow[1].innerHTML, "DD MMM YYYY, LT").format(); // select date from 2nd column in table

            // Skip template
            if (!row.closest('[data-kt-docs-datatable-subtable="subtable_template"]')) {
                dateRow[1].setAttribute('data-order', realDate);
                dateRow[1].innerText = moment(realDate).fromNow();
            }
        });

        // Get subtable template
        const subtable = document.querySelector('[data-kt-docs-datatable-subtable="subtable_template"]');
        template = subtable.cloneNode(true);
        template.classList.remove('d-none');

        // Remove subtable template
        subtable.parentNode.removeChild(subtable);

        // Init datatable --- more info on datatables: https://datatables.net/manual/
        datatable = $(table).DataTable({
            "info": false,
            'order': [],
            "lengthChange": false,
            'pageLength': 6,
            'ordering': false,
            'paging': false,
            'columnDefs': [
                { orderable: false, targets: 0 }, // Disable ordering on column 0 (checkbox)
                { orderable: false, targets: 6 }, // Disable ordering on column 6 (actions)
            ]
        });

        // Re-init functions on every table re-draw -- more info: https://datatables.net/reference/event/draw
        datatable.on('draw', function () {
            resetSubtable();
            handleActionButton();
        });
    }

    // Subtable data sample
    const data = [
        {
            image: '76',
            name: 'Go Pro 8',
            description: 'Latest  version of Go Pro.',
            cost: '500.00',
            qty: '1',
            total: '500.00',
            stock: '12'
        },
        {
            image: '60',
            name: 'Bose Earbuds',
            description: 'Top quality earbuds from Bose.',
            cost: '300.00',
            qty: '1',
            total: '300.00',
            stock: '8'
        },
        {
            image: '211',
            name: 'Dry-fit Sports T-shirt',
            description: 'Comfortable sportswear for everyday use.',
            cost: '89.00',
            qty: '1',
            total: '89.00',
            stock: '18'
        },
        {
            image: '21',
            name: 'Apple Airpod 3',
            description: 'Apple\'s latest and most advanced earbuds.',
            cost: '200.00',
            qty: '2',
            total: '400.00',
            stock: '32'
        },
        {
            image: '83',
            name: 'Nike Pumps',
            description: 'Apple\'s latest and most advanced headphones.',
            cost: '200.00',
            qty: '1',
            total: '200.00',
            stock: '8'
        }
    ];

    // Handle action button
    const handleActionButton = () => {
        const buttons = document.querySelectorAll('[data-kt-docs-datatable-subtable="expand_row"]');

        // Sample row items counter --- for demo purpose only, remove this variable in your project
        const rowItems = [4, 1, 5, 1, 4, 2];

        buttons.forEach((button, index) => {
            button.addEventListener('click', e => {
                e.stopImmediatePropagation();
                e.preventDefault();

                const row = button.closest('tr');
                const rowClasses = ['isOpen', 'border-bottom-0'];

                // Get total number of items to generate --- for demo purpose only, remove this code snippet in your project
                const demoData = [];
                for (var j = 0; j < rowItems[index]; j++) {
                    demoData.push(data[j]);
                }
                // End of generating demo data

                // Handle subtable expanded state
                if (row.classList.contains('isOpen')) {
                    // Remove all subtables from current order row
                    while (row.nextSibling && row.nextSibling.getAttribute('data-kt-docs-datatable-subtable') === 'subtable_template') {
                        row.nextSibling.parentNode.removeChild(row.nextSibling);
                    }
                    row.classList.remove(...rowClasses);
                    button.classList.remove('active');
                } else {
                    populateTemplate(demoData, row);
                    row.classList.add(...rowClasses);
                    button.classList.add('active');
                }
            });
        });
    }

    // Populate template with content/data -- content/data can be replaced with relevant data from database or API
    const populateTemplate = (data, target) => {
        data.forEach((d, index) => {
            // Clone template node
            const newTemplate = template.cloneNode(true);

            // Stock badges
            const lowStock = `<div class="badge badge-light-warning">Low Stock</div>`;
            const inStock = `<div class="badge badge-light-success">In Stock</div>`;

            // Select data elements
            const image = newTemplate.querySelector('[data-kt-docs-datatable-subtable="template_image"]');
            const name = newTemplate.querySelector('[data-kt-docs-datatable-subtable="template_name"]');
            const description = newTemplate.querySelector('[data-kt-docs-datatable-subtable="template_description"]');
            const cost = newTemplate.querySelector('[data-kt-docs-datatable-subtable="template_cost"]');
            const qty = newTemplate.querySelector('[data-kt-docs-datatable-subtable="template_qty"]');
            const total = newTemplate.querySelector('[data-kt-docs-datatable-subtable="template_total"]');
            const stock = newTemplate.querySelector('[data-kt-docs-datatable-subtable="template_stock"]');

            // Populate elements with data
            const imageSrc = image.getAttribute('src');
            image.setAttribute('src', imageSrc + d.image + '.png');
            name.innerText = d.name;
            description.innerText = d.description;
            cost.innerText = d.cost;
            qty.innerText = d.qty;
            total.innerText = d.total;
            if (d.stock > 10) {
                stock.innerHTML = inStock;
            } else {
                stock.innerHTML = lowStock;
            }

            // New template border controller
            // When only 1 row is available
            if (data.length === 1) {
                let borderClasses = ['rounded', 'rounded-end-0'];
                newTemplate.querySelectorAll('td')[0].classList.add(...borderClasses);
                borderClasses = ['rounded', 'rounded-start-0'];
                newTemplate.querySelectorAll('td')[4].classList.add(...borderClasses);

                // Remove bottom border
                newTemplate.classList.add('border-bottom-0');
            } else {
                // When multiple rows detected
                if (index === (data.length - 1)) { // first row
                    let borderClasses = ['rounded-start', 'rounded-bottom-0'];
                    newTemplate.querySelectorAll('td')[0].classList.add(...borderClasses);
                    borderClasses = ['rounded-end', 'rounded-bottom-0'];
                    newTemplate.querySelectorAll('td')[4].classList.add(...borderClasses);
                }
                if (index === 0) { // last row
                    let borderClasses = ['rounded-start', 'rounded-top-0'];
                    newTemplate.querySelectorAll('td')[0].classList.add(...borderClasses);
                    borderClasses = ['rounded-end', 'rounded-top-0'];
                    newTemplate.querySelectorAll('td')[4].classList.add(...borderClasses);

                    // Remove bottom border on last row
                    newTemplate.classList.add('border-bottom-0');
                }
            }

            // Insert new template into table
            const tbody = table.querySelector('tbody');
            tbody.insertBefore(newTemplate, target.nextSibling);
        });
    }

    // Reset subtable
    const resetSubtable = () => {
        const subtables = document.querySelectorAll('[data-kt-docs-datatable-subtable="subtable_template"]');
        subtables.forEach(st => {
            st.parentNode.removeChild(st);
        });

        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(r => {
            r.classList.remove('isOpen');
            if (r.querySelector('[data-kt-docs-datatable-subtable="expand_row"]')) {
                r.querySelector('[data-kt-docs-datatable-subtable="expand_row"]').classList.remove('active');
            }
        });
    }

    // Public methods
    return {
        init: function () {
            table = document.querySelector('#kt_docs_datatable_subtable');

            if (!table) {
                return;
            }

            initDatatable();
            handleActionButton();
        }
    }
}();

// Webpack support
if (typeof module !== 'undefined') {
    module.exports = KTDocsDatatableSubtable;
}

// On document ready
KTUtil.onDOMContentLoaded(function () {
    KTDocsDatatableSubtable.init();
});

</script>


<script>
    $(document).ready(function() {

        var year = '{{ year }}';  // Obtener el año del contexto de Django
        var mth = '{{ mth }}';  
        // Inicializar DataTable
        var table = $('#table-vacation').DataTable({
            language: {
                "decimal": "",
                "emptyTable": "No se encontraron registros coincidentes",
                "info": "Mostrando _START_ a _END_ de _TOTAL_ entradas",
                "infoEmpty": "Mostrando 0 a 0 de 0 entradas",
                "infoFiltered": "(filtrado de _MAX_ entradas totales)",
                "thousands": ",",
                "lengthMenu": "Mostrar _MENU_ entradas",
                "loadingRecords": "Cargando...",
                "processing": "Procesando...",
                "search": "Buscar:",
                "zeroRecords": "No se encontraron registros coincidentes",
                "paginate": {
                    "first": "Primero",
                    "last": "Último",
                    "next": "Siguiente",
                    "previous": "Anterior"
                },
                "aria": {
                    "sortAscending": ": activar para ordenar la columna ascendente",
                    "sortDescending": ": activar para ordenar la columna descendente"
                }
            },
            dom: 'frtip',
            // buttons: [
            //     {
            //         text: ' <i class="fa-solid fa-receipt"></i> Descargar Excel  ',
            //         className: 'btn btn-light-info',
            //         action: function (e, dt, node, config) {
            //             window.location.href = '{% url "companies:download_excel_report" %}?year=' + encodeURIComponent(year) + '&mth=' + encodeURIComponent(mth);
            //         }
            //     },
            // ],
            order: [],
            pageLength: 6
        });
    });
</script>


{% endblock %}

